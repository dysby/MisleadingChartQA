<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Rate Comparison</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        #chart {
            width: 1000px;
            height: 750px;
            margin: 60px auto;
        }
        body {
            font-family: Arial, sans-serif;
        }
        h2 {
            text-align: center;
            font-size: 18px;
        }
        .legend {
            font-size: 12px;
        }
        .map {
            stroke: #fff;
            stroke-width: 1px;
        }
    </style>
</head>
<body>
    <h1>Crime Rates: Violent vs Property Crimes</h1>
    <div id="chart"></div>
    <script>
        const width = 1000;
        const height = 750;

        const mapWidth = width / 2; 
        const mapHeight = height / 2; 

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        Promise.all([
            d3.json("https://d3js.org/us-10m.v1.json"),
            d3.csv("../../../../data/MS_inappropriate_scale_range/choropleth_map/MS_inappropriate_scale_range_choropleth_map_4.csv") 
        ]).then(([us, data]) => {
            const crimeData = {};
            data.forEach(d => {
                crimeData[d.id] = { violent_crimes: +d.violent_crimes, property_crimes: +d.property_crimes };
            });

            // Calculate appropriate scale ranges based on actual data
            const violentValues = data.map(d => +d.violent_crimes);
            const propertyValues = data.map(d => +d.property_crimes);
            
            const violentExtent = d3.extent(violentValues);
            const propertyExtent = d3.extent(propertyValues);
            
            const colorScaleViolent = d3.scaleThreshold()
                .domain([
                    violentExtent[0] + (violentExtent[1] - violentExtent[0]) * 0.33,
                    violentExtent[0] + (violentExtent[1] - violentExtent[0]) * 0.67
                ])
                .range(["#FEE0D2", "#FC9272", "#DE2D26"]);
            
            const colorScaleProperty = d3.scaleThreshold()
                .domain([
                    propertyExtent[0] + (propertyExtent[1] - propertyExtent[0]) * 0.33,
                    propertyExtent[0] + (propertyExtent[1] - propertyExtent[0]) * 0.67
                ])
                .range(["#FEE0D2", "#FC9272", "#DE2D26"]);

            const states = topojson.feature(us, us.objects.states).features;

            // Calculate thresholds for legend labels
            const violentThreshold1 = Math.round(violentExtent[0] + (violentExtent[1] - violentExtent[0]) * 0.33);
            const violentThreshold2 = Math.round(violentExtent[0] + (violentExtent[1] - violentExtent[0]) * 0.67);
            const propertyThreshold1 = Math.round(propertyExtent[0] + (propertyExtent[1] - propertyExtent[0]) * 0.33);
            const propertyThreshold2 = Math.round(propertyExtent[0] + (propertyExtent[1] - propertyExtent[0]) * 0.67);

            drawMap(states, "violent_crimes", mapWidth / 2.5, 0, colorScaleViolent, "Violent Crimes (per 100k)", violentThreshold1, violentThreshold2, " per 100k");
            drawMap(states, "property_crimes", mapWidth / 2.5, mapHeight, colorScaleProperty, "Property Crimes (per 100k)", propertyThreshold1, propertyThreshold2, " per 100k");

            function drawMap(states, type, xOffset, yOffset, colorScale, title, threshold1, threshold2, suffix) {
                const mapGroup = svg.append("g")
                    .attr("transform", `translate(${xOffset}, ${yOffset}) scale(${mapWidth / width}, ${mapHeight / height})`);

                mapGroup.append("text")
                    .attr("x", width / 2)
                    .attr("y", 15)
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .style("font-weight", "bold")
                    .text(title);

                mapGroup.selectAll(".state")
                    .data(states)
                    .enter().append("path")
                    .attr("class", "map")
                    .attr("d", d3.geoPath())
                    .attr("fill", d => {
                        const value = crimeData[d.id]?.[type];
                        return value ? colorScale(value) : "#ccc";
                    });

                const legend = mapGroup.append("g")
                    .attr("transform", `translate(${mapWidth - 150}, ${height - 150})`);

                const legendData = [
                    { color: "#DE2D26", label: `High (${threshold2}+${suffix})` },
                    { color: "#FC9272", label: `Medium (${threshold1}-${threshold2 - 1}${suffix})` },
                    { color: "#FEE0D2", label: `Low (<${threshold1}${suffix})` }
                ];

                legend.selectAll("rect")
                    .data(legendData)
                    .enter().append("rect")
                    .attr("x", 0)
                    .attr("y", (d, i) => i * 20)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", d => d.color);

                legend.selectAll("text")
                    .data(legendData)
                    .enter().append("text")
                    .attr("x", 24)
                    .attr("y", (d, i) => i * 20 + 14)
                    .text(d => d.label);
            }
        });
    </script>
</body>
</html>
