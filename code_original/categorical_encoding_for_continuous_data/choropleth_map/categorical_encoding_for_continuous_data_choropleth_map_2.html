<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>US Choropleth with State Labels</title>
    <!-- D3 v6 and TopoJSON v3 -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #map {
            width: 1000px;
            height: 700px;
            position: relative;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            padding: 6px;
            font: 14px sans-serif;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }
        .legend {
            font-size: 14px;
        }
        .state-label {
            font-size: 8px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none; /* let mouse events pass through label */
        }
    </style>
</head>
<body>
    <h1>US Unemployment Rate by State (2023)</h1>
    <div id="map"></div>

    <script>
        const width = 1000;
        const height = 700;

        // Append an SVG to #map
        const svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // GeoAlbersUsa projection
        const projection = d3.geoAlbersUsa()
            .scale(1300)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath(projection);

        // A categorical color scale for unemployment rate
        // Domain = break points in unemployment rate (%)
        const colorScale = d3.scaleSequential(d3.interpolateYlOrRd)
            .domain([0, 12]);

        // Tooltip for hover info
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip");

        // Load the TopoJSON (us-atlas) & CSV in parallel
        Promise.all([
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json"),
            d3.csv("../../../../data/categorical_encoding_for_continuous_data/choropleth_map/categorical_encoding_for_continuous_data_choropleth_map_2.csv")  // must be in the same folder
        ]).then(([us, data]) => {
            // Build a dictionary: fips -> { name, rate }
            const rateById = {};
            data.forEach(d => {
                rateById[d.id] = {
                    name: d.State,
                    rate: +d.UnemploymentRate
                };
            });
            console.log("rateById", rateById);

            // Convert the states TopoJSON to GeoJSON
            const states = topojson.feature(us, us.objects.states).features;

            // Draw the states
            svg.selectAll("path")
                .data(states)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", d => {
                    // Convert numeric fips to two-digit string
                    const fips = d.id.toString().padStart(2, "0");
                    const info = rateById[fips];
                    if (info) {
                        return colorScale(info.rate);
                    } else {
                        return "#ddd"; // no data
                    }
                })
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)


            // Add labels (use the same states array)
            svg.selectAll(".state-label")
                .data(states)
                .enter()
                .append("text")
                .attr("class", "state-label")
                .attr("transform", d => {
                    const [x, y] = path.centroid(d);
                    if (isNaN(x) || isNaN(y)) {
                        return `translate(0, 0)`; // Fallback to default coordinates
                    }
                    return `translate(${x}, ${y})`;
                })
                .text(d => {
                    const fips = d.id.toString().padStart(2, "0");
                    const info = rateById[fips];
                    return info ? info.name : "";
                })
                .style("font-size", "10px")
                .style("font-weight", "bold");

            // Build a continuous gradient legend
            const legendHeight = 200;
            const legendWidth = 20;
            
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(900, 300)`);

            // Create gradient
            const defs = svg.append("defs");
            const linearGradient = defs.append("linearGradient")
                .attr("id", "rate-gradient")
                .attr("x1", "0%")
                .attr("y1", "100%")
                .attr("x2", "0%")
                .attr("y2", "0%");

            // Create gradient stops
            const numStops = 10;
            const domain = colorScale.domain();
            for (let i = 0; i <= numStops; i++) {
                const value = domain[0] + (i / numStops) * (domain[1] - domain[0]);
                linearGradient.append("stop")
                    .attr("offset", (i / numStops * 100) + "%")
                    .attr("stop-color", colorScale(value));
            }

            // Draw legend rectangle
            legend.append("rect")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#rate-gradient)");

            // Add legend scale
            const legendScale = d3.scaleLinear()
                .domain(domain)
                .range([legendHeight, 0]);

            const legendAxis = d3.axisRight(legendScale)
                .ticks(6);

            legend.append("g")
                .attr("transform", `translate(${legendWidth}, 0)`)
                .call(legendAxis);
        });
    </script>
</body>
</html> 