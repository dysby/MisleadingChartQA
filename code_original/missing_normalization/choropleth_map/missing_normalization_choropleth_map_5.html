<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>choropleth_map Visualization</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        #chart {
            width: 1000px;
            height: 750px;
            margin: 60px auto;
        }
        .bar {
            fill: steelblue;
        }
        .axis path, .axis line {
            stroke: black;
        }
    </style>
</head>
<body>
    <h1>Confirmed Outbreak Cases (Totals)</h1>
    <div id="chart"></div>
    <script>
        const width = 1000; const height = 750;
        const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height);
        const projection = d3.geoMercator().scale(150).translate([width/2.5, height/2.5]);
        const path = d3.geoPath().projection(projection);
        const colorScale = d3.scaleSequential(d3.interpolateOrRd).domain([0, 22000]);

        Promise.all([
            d3.json("https://d3js.org/world-110m.v1.json"),
            d3.csv("../../../../data/missing_normalization/choropleth_map/missing_normalization_choropleth_map_5.csv")
        ]).then(([world, data]) => {
            const countries = topojson.feature(world, world.objects.countries).features;
            const valueById = {}; data.forEach(d => valueById[d.id] = +d.cases);
            // Base outlines for all countries
            svg.append("g").selectAll("path").data(countries).enter().append("path")
                .attr("d", path)
                .attr("fill", "#efefef")
                .attr("stroke", "#666")
                .attr("stroke-width", 0.8);

            // Data fills where present
            svg.append("g").selectAll("path").data(countries).enter().append("path")
                .attr("d", path)
                .attr("fill", d => { const v = valueById[d.id]||0; return v ? colorScale(v) : 'transparent'; })
                .attr("stroke", d => (valueById[d.id] ? "#fff" : "none"))
                .attr("stroke-width", d => (valueById[d.id] ? 0.8 : 0));
            svg.selectAll("text").data(data).enter().append("text").text(d=>d.label)
                .attr("x", d=>{ const c=countries.find(x=>x.id==d.id); const ct=c?path.centroid(c):[0,0]; return ct[0]; })
                .attr("y", d=>{ const c=countries.find(x=>x.id==d.id); const ct=c?path.centroid(c):[0,0]; return ct[1]; })
                .attr("font-size", 18).attr("font-weight", "bold");

            // Legend
            const legendHeight = 200;
            const legendScale = d3.scaleLinear().domain([0, 22000]).range([legendHeight, 0]);
            const legendAxis = d3.axisRight(legendScale).ticks(6).tickFormat(d3.format(",.0f"));
            const legend = svg.append("g").attr("class", "legend").attr("transform", `translate(${width - 80}, 100)`);
            legend.append("text").text("Cases (total)").attr("x", 0).attr("y", legendHeight + 40);
            legend.selectAll("rect")
                .data(d3.range(0, 22000, 2200))
                .enter().append("rect")
                .attr("x", 0)
                .attr("y", d => legendScale(d + 2200))
                .attr("width", 20)
                .attr("height", 17)
                .attr("fill", d => colorScale(d + 1100));
            legend.append("g").attr("transform", "translate(20, 0)").call(legendAxis);
        });
    </script>
</body>
</html>
